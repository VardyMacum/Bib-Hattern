<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>PatternTrader Pro</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>

  <!-- Firebase SDKs for Realtime Database -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Segoe UI', sans-serif; background: #000; color: #333; overflow-x: hidden; }
    header { display: flex; justify-content: space-between; padding: 1rem; background: #1f2937; color: #fff; }
    footer { text-align: center; padding: 1rem; color: #777; }

    /* Side Menu */
    #side-menu { position: fixed; top: 0; left: -260px; width: 260px; height: 100%; background: linear-gradient(135deg, #000, #000); box-shadow: 4px 0 15px rgba(16,185,129,0.6); color: #d1d5db; transition: left .35s cubic-bezier(.4,0,.2,1); padding:1.5rem; z-index:1000; display:flex; flex-direction:column; gap:1rem; }
    #side-menu.open { left: 0; }
    #side-menu .close-btn { align-self:flex-end; background:transparent; border:none; color:#10b981; font-size:1.5rem; cursor:pointer; }
    #side-menu button { width:100%; background:#0f172a; border:2px solid #000; color:#fff; padding:.75rem 1rem; font-size:1.1rem; border-radius:8px; cursor:pointer; font-weight:600; box-shadow:0 0 8px #1021b944; transition: .3s; }
    #side-menu button:hover { background:#7510b9; color:#0f172a; box-shadow:0 0 10px #3510b9,0 0 30px #00e1ff; transform:scale(1.05); }

    .hamburger { cursor:pointer; width:30px; height:24px; display:flex; flex-direction:column; justify-content:space-between; }
    .hamburger div { height:4px; background:#fff; border-radius:2px; }

    main { display:flex; flex-direction:column; gap:1rem; max-width:1400px; margin:2rem auto; }
    .card { background:#fff; border-radius:8px; padding:1rem; }
    .chart-wrapper { position:relative; height:400px; overflow:hidden; }
    #d3-chart { width:100%; height:100%; }
    .timer { position:absolute; top:10px; right:20px; background:rgba(0,0,0,0.6); color:#fff; padding:.5rem 1rem; border-radius:4px; font-weight:bold; }
    .line { stroke:#007acc; fill:none; stroke-width:2; filter:drop-shadow(0 0 6px rgba(0,122,204,0.8)); }
    .pin { position:absolute; width:12px; height:12px; border-radius:50%; background:#10b981; box-shadow:0 0 8px #10b981,0 0 16px #10b981; pointer-events:none; }

    .controls { display:flex; align-items:center; gap:1rem; margin-top:1rem; }
    input[type=number], button { padding:.5rem; border-radius:4px; border:1px solid #ccc; }
    .buy { background:#10b981; color:#000; }
    .sell { background:#ef4444; color:#fff; }

    .bottom-row { display:flex; gap:1rem; align-items:flex-start; }
    .stats, .trades-log { flex:1; }
    /* Fixed width for stats card so it doesn\'t resize based on trade history */
    .card.stats { flex: 0 0 300px; }
    .stats { display:flex; justify-content:space-between; margin-top:1rem; }
    .stat { background:#f9fafb; padding:.75rem; border-radius:4px; flex:1; text-align:center; margin:0 .25rem; }
    .trades-log { background:#fff; border:2px solid #ddd; border-radius:8px; padding:1rem; flex:1; }
    .trades-log ul { list-style:none; max-height:200px; overflow-y:auto; }
    .trades-log li { display:flex; justify-content:space-between; padding:.5rem 0; border-bottom:1px solid #eee; }

    .popup { position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:rgba(0,0,0,0.85); color:#fff; padding:1rem 1.5rem; border-radius:6px; opacity:0; pointer-events:none; transition:opacity .3s; z-index:1001; }
    .popup.show { opacity:1; }
  </style>
</head>
<body>
  <header>
    <div class="hamburger" onclick="toggleMenu()"><div></div><div></div><div></div></div>
    <h1>PatternTrader Pro</h1>
    <div>Balance: $<span id="balance">0.00</span></div>
  </header>

  <div id="side-menu">
    <button class="close-btn" onclick="toggleMenu()">Ã—</button>
    <button onclick="deposit()">Deposit</button>
    <button onclick="withdraw()">Withdraw</button>
    <button onclick="triggerReset()">Reset</button>
    <button onclick="logout()">Log Out</button>
  </div>

  <main>
    <div class="card">
      <h2>Live Pattern Chart</h2>
      <div class="chart-wrapper">
        <svg id="d3-chart"></svg>
        <div id="trade-timer" class="timer"></div>
      </div>
      <div class="controls">
        <label for="trade-amount">Amount ($):</label>
        <input type="number" id="trade-amount" min="1" value="10">
        <button class="buy" onclick="placeTrade('buy')">Buy</button>
        <button class="sell" onclick="placeTrade('sell')">Sell</button>
      </div>
    </div>
    <div class="bottom-row">
      <div class="card stats">
        <h2>Stats</h2>
        <div class="stats">
          <div class="stat"><div>Traders</div><div id="traders-count">0</div></div>
          <div class="stat"><div>Buys</div><div id="buy-count">0</div></div>
          <div class="stat"><div>Sells</div><div id="sell-count">0</div></div>
        </div>
      </div>
      <div class="card trades-log">
        <h3>Trade History</h3>
        <ul id="trades-list"></ul>
      </div>
    </div>
  </main>

  <footer>&copy; <span id="year"></span> PatternTrader Pro</footer>
  <div class="popup" id="popup"></div>

  <script>
    // Generate or retrieve unique user ID for this device
    let userId = localStorage.getItem('pt_userId');
    if (!userId) {
      userId = 'user_' + Date.now() + '_' + Math.floor(Math.random() * 100000);
      localStorage.setItem('pt_userId', userId);
    }
    console.log('User ID:', userId);

    // UI toggles
    function toggleMenu() { document.getElementById('side-menu').classList.toggle('open'); }
    function showPopup(msg, t = 2000) { const p = document.getElementById('popup'); p.textContent = msg; p.classList.add('show'); setTimeout(() => p.classList.remove('show'), t); }
    function logout() { window.location = 'Login.html'; }

    // State & storage
    const STORAGE_KEY = 'pt_state_' + userId;
    const CHART_KEY   = 'pt_chart_' + userId;
    let state = JSON.parse(localStorage.getItem(STORAGE_KEY)) || { balance: 1000, price: 1.2, traders: 0, buys: 0, sells: 0, trades: [] };
    let data = JSON.parse(localStorage.getItem(CHART_KEY)) || d3.range(60).map((_, i) => ({ time: Date.now() - (60 - i)*1000, price: state.price }));

    // Elements
    const balanceEl     = document.getElementById('balance'),
          tradersEl     = document.getElementById('traders-count'),
          buyCountEl    = document.getElementById('buy-count'),
          sellCountEl   = document.getElementById('sell-count'),
          tradesList    = document.getElementById('trades-list'),
          yearEl        = document.getElementById('year'),
          wrapper       = document.querySelector('.chart-wrapper');
    yearEl.textContent = new Date().getFullYear();

    // D3 setup
    const svg    = d3.select('#d3-chart'),
          margin = { top: 20, right: 20, bottom: 30, left: 40 };
    let W = wrapper.clientWidth - margin.left - margin.right,
        H = wrapper.clientHeight - margin.top - margin.bottom;
    svg.attr('viewBox', `0 0 ${W+margin.left+margin.right} ${H+margin.top+margin.bottom}`);
    const g    = svg.append('g').attr('transform', `translate(${margin.left},${margin.top})`);
    const x    = d3.scaleTime().range([0, W]),
          y    = d3.scaleLinear().range([H, 0]);
    const line = d3.line().x(d => x(d.time)).y(d => y(d.price)).curve(d3.curveMonotoneX);
    const path = g.append('path').datum(data).attr('class', 'line');
    g.append('g').attr('class', 'x axis').attr('transform', `translate(0,${H})`);
    g.append('g').attr('class', 'y axis');

    let tradeLock = false, buyTimestamps = [], sellTimestamps = [];
    function updateScales() { x.domain(d3.extent(data, d => d.time)); y.domain([d3.min(data, d => d.price)*0.998, d3.max(data, d => d.price)*1.002]); }
    function draw() { path.datum(data).attr('d', line); g.select('.x.axis').call(d3.axisBottom(x).ticks(5).tickFormat(d3.timeFormat('%H:%M:%S'))); g.select('.y.axis').call(d3.axisLeft(y)); }

    function simulateTick() {
      const last = data[data.length-1].price;
      let pressure = (state.buys - state.sells)*0.0001;
      const now = Date.now();
      if (buyTimestamps.filter(ts => now - ts < 120000).length > 3) pressure *= -1;
      if (sellTimestamps.filter(ts => now - ts < 90000).length > 3) pressure *= -1;
      const rand = (Math.random() - 0.5)*0.001;
      const next = last*(1 + rand + pressure);
      state.price = +next.toFixed(5);
      state.traders += Math.floor(Math.random()*2);
      data.push({ time: Date.now(), price: state.price }); data.shift();
      updateScales(); draw(); updateUI(); save();
    }
    setInterval(simulateTick, 1000);

    function placeTrade(type) {
      if (tradeLock) { showPopup('Please wait for timer'); return; }
      const amt = parseFloat(document.getElementById('trade-amount').value);
      if (!amt || amt <= 0 || amt > state.balance) { showPopup('Invalid trade amount.'); return; }
      state.balance -= amt;
      if (type === 'buy') { state.buys++; buyTimestamps.push(Date.now()); } else { state.sells++; sellTimestamps.push(Date.now()); }
      const now = Date.now(), trade = { type, entry: state.price, entryTime: now, amount: amt };
      state.trades.push(trade);
      if (state.trades.length > 100) state.trades.shift();

      // pin
      const pin = document.createElement('div'); pin.className = 'pin';
      const px = x(trade.entryTime) + margin.left, py = y(trade.entry) + margin.top;
      pin.style.left = px + 'px'; pin.style.top = py + 'px'; wrapper.appendChild(pin);

      updateUI(); save();
      // resolve
      setTimeout(() => {
        const exit = state.price;
        const pip  = (exit - trade.entry)/0.0001;
        const pnl  = pip*0.0001*trade.amount*(trade.type === 'buy'? 1 : -1);
        state.balance += amt + pnl; trade.pnl = pnl;
        updateUI(); save(); showPopup((pnl >= 0 ? 'Profit: +$' : 'Loss: $') + Math.abs(pnl).toFixed(2)); pin.remove();
      }, 10000);
      // cooldown
      tradeLock = true;
      let cd = 10;
      const tEl = document.getElementById('trade-timer'); tEl.textContent = `Next in ${cd}s`;
      const iv = setInterval(() => {
        cd--;
        if (cd <= 0) { clearInterval(iv); tradeLock = false; tEl.textContent = ''; }
        else tEl.textContent = `Next in ${cd}s`;
      }, 1000);
    }

    function updateUI() {
      balanceEl.textContent = state.balance.toFixed(2);
      tradersEl.textContent = state.traders;
      buyCountEl.textContent = state.buys;
      sellCountEl.textContent = state.sells;
      tradesList.innerHTML = '';
      state.trades.slice(-15).reverse().forEach(t => {
        const li = document.createElement('li');
        li.innerHTML = `<span>${new Date(t.entryTime).toLocaleTimeString()} ${t.type.toUpperCase()}</span><span>${t.amount.toFixed(2)}</span>`;
        tradesList.appendChild(li);
      });
    }

    function deposit() { const amt = parseFloat(prompt('Deposit amount:')); if (amt > 0) { state.balance += amt; updateUI(); save(); showPopup(`Deposited $${amt.toFixed(2)}`); } else showPopup('Invalid deposit'); toggleMenu(); }
    function withdraw() { const amt = parseFloat(prompt('Withdrawal amount:')); if (amt > 0 && amt <= state.balance) { state.balance -= amt; updateUI(); save(); showPopup(`Withdrew $${amt.toFixed(2)}`); } else showPopup('Invalid withdraw'); toggleMenu(); }
    function triggerReset() { if (confirm('Reset all data?')) { state = { balance:1000, price:1.2, traders:0, buys:0, sells:0, trades:[] }; data = d3.range(60).map((_,i) => ({ time: Date.now() - (60 - i)*1000, price:state.price })); updateScales(); draw(); updateUI(); save(); showPopup('Reset complete'); } toggleMenu(); }
    function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); localStorage.setItem(CHART_KEY, JSON.stringify(data)); }
    window.addEventListener('resize', () => { W = wrapper.clientWidth - margin.left - margin.right; H = wrapper.clientHeight - margin.top - margin.bottom; svg.attr('viewBox', `0 0 ${W+margin.left+margin.right} ${H+margin.top+margin.bottom}`); x.range([0, W]); y.range([H, 0]); updateScales(); draw(); });

    updateScales(); draw(); updateUI();
  </script>
</body>
</html>
